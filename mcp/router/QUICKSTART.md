# Router MCP Server - Quick Start

The Router MCP Server is the **execution engine** for GAFF workflows. It:
- ✅ Executes intent graphs generated by `intent-graph-generator`
- ✅ Manages state via the Memory MCP server
- ✅ Orchestrates agent calls
- ✅ Supports parallel execution
- ✅ Handles HITL (Human-in-the-Loop) pausing

## Quick Test

```bash
cd mcp/router
npm install
npm run build

# Test with example graph
node test-execution.js
```

## Use with Claude Desktop

Add to your MCP config (`%APPDATA%\Claude\claude_desktop_config.json`):

```json
{
  "mcpServers": {
    "router": {
      "command": "node",
      "args": ["/path/to/gaff/mcp/router/build/index.js"]
    },
    "memory": {
      "command": "npx",
      "args": ["-y", "@modelcontextprotocol/server-memory"]
    }
  }
}
```

**Note**: Router requires the Memory MCP server to be running for state management.

## Example Usage

### 1. Execute a Graph

```javascript
{
  "name": "execute_graph",
  "arguments": {
    "graph": {
      "graph_id": "workflow_001",
      "version": "1.0",
      "nodes": [
        {
          "id": "fetch_data",
          "agent": "data-agent",
          "tool": "get_data",
          "input": { "source": "api" },
          "dependencies": []
        },
        {
          "id": "process_data",
          "agent": "processor",
          "tool": "transform",
          "input": { "data": "${fetch_data.result}" },
          "dependencies": ["fetch_data"]
        }
      ],
      "edges": [
        { "from": "fetch_data", "to": "process_data" }
      ]
    },
    "config": {
      "max_parallel": 3,
      "enable_hitl": true,
      "store_state_in_memory": true
    }
  }
}
```

### 2. Check Execution Status

```javascript
{
  "name": "get_execution_status",
  "arguments": {
    "execution_id": "exec_1696543210_abc123"
  }
}
```

### 3. Route to Single Agent

```javascript
{
  "name": "route_to_agent",
  "arguments": {
    "agent_name": "my-agent",
    "tool_name": "process_data",
    "input": {
      "data": [1, 2, 3, 4, 5]
    },
    "retry_config": {
      "max_attempts": 3,
      "backoff_strategy": "exponential"
    }
  }
}
```

## Features

### ✅ DAG Validation
Automatically validates that your graph is a valid Directed Acyclic Graph (no cycles).

### ✅ Topological Execution
Executes nodes in the correct dependency order.

### ✅ Parallel Execution
Groups independent nodes and executes them in parallel for better performance.

### ✅ Memory-Backed State
All execution state, node results, and context variables are stored in the Memory MCP server for:
- Resuming paused executions
- Debugging failed nodes
- Auditing workflow history

### ✅ Variable Resolution
Automatically resolves variable references in node inputs:
- `${node_id.result.key}` - Reference output from previous node
- `${context_variable}` - Reference execution context

### ✅ HITL Support
Automatically pauses execution when encountering Human-in-the-Loop nodes:
```javascript
{
  "id": "approval_gate",
  "agent": "gaff-tools",
  "tool": "human_in_the_loop",
  "input": {
    "action_description": "Approve data deletion",
    "context": { "records": 150 }
  },
  "dependencies": ["identify_records"]
}
```

### ✅ Error Handling
- Automatic retries with exponential backoff
- Failed node tracking
- Graceful degradation

## Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `MEMORY_MCP_COMMAND` | Command to start memory server | `npx` |
| `MEMORY_MCP_ARGS` | Args for memory server (comma-separated) | `-y,@modelcontextprotocol/server-memory` |

## Execution Lifecycle

1. **Validate** - Check graph is valid DAG
2. **Sort** - Perform topological sort
3. **Group** - Group nodes for parallel execution
4. **Execute** - Run nodes, resolve variables, store results
5. **Store** - Save state to memory after each node
6. **Complete** - Return final results

## Next Steps

- See `examples/simple-graph.json` for graph structure
- Review full documentation in `README.md`
- Check `mcp/intent-graph-generator` for graph generation
- Explore `mcp/agent-orchestration` for workflow planning

## Troubleshooting

**Memory server not connecting:**
```bash
# Test memory server directly
npx -y @modelcontextprotocol/server-memory
```

**Graph validation failed:**
- Check for circular dependencies
- Ensure all node IDs are unique
- Verify dependency references exist

**Node execution failed:**
- Check agent configuration in `gaff.json`
- Verify agent endpoints are accessible
- Review retry configuration

## Status

- ✅ Core execution engine
- ✅ Memory integration
- ✅ Parallel execution
- ✅ HITL support
- ⚠️  Agent routing (placeholder - needs real MCP/HTTP clients)
- ⚠️  Quality-check integration (placeholder)


